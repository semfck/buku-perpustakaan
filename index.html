<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin - Manajemen Buku</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="admin-buku.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container mt-4">
    <!-- AUTH & LOGIN SECTION -->
    <div id="authSection" class="mb-4">
      <div id="userInfo" style="display:none">
        <span id="userEmail" class="me-2"></span>
        <button id="logoutBtn" class="btn btn-secondary btn-sm">Logout</button>
      </div>
      <form id="loginForm" class="row g-2" style="max-width:350px">
        <div class="col-12">
          <input type="email" id="loginEmail" class="form-control" placeholder="Email (contoh: admin@domain.com)" required autocomplete="username">
        </div>
        <div class="col-12">
          <input type="password" id="loginPassword" class="form-control" placeholder="Password (contoh: 123456)" required autocomplete="current-password">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary w-100">Login Admin</button>
        </div>
      </form>
    </div>
    <!-- ADMIN SECTION -->
    <div id="adminSection" style="display:none">
      <h2>Admin: Manajemen Buku</h2>
      <form id="formTambahBuku" class="row g-3 mb-4 needs-validation" novalidate>
        <div class="col-md-3">
          <input required type="text" class="form-control" id="judul" placeholder="Judul Buku">
          <div class="invalid-feedback">Judul wajib diisi!</div>
        </div>
        <div class="col-md-2">
          <input required type="text" class="form-control" id="pengarang" placeholder="Pengarang">
          <div class="invalid-feedback">Pengarang wajib diisi!</div>
        </div>
        <div class="col-md-1">
          <input required type="number" min="1000" max="9999" class="form-control" id="tahun" placeholder="Tahun">
          <div class="invalid-feedback">Tahun wajib 4 digit!</div>
        </div>
        <div class="col-md-2">
          <select required class="form-select" id="kategori">
            <option value="">Kategori...</option>
            <option value="Fiksi">Fiksi</option>
            <option value="Non-Fiksi">Non-Fiksi</option>
            <option value="Teknologi">Teknologi</option>
            <option value="Sejarah">Sejarah</option>
          </select>
          <div class="invalid-feedback">Pilih kategori!</div>
        </div>
        <div class="col-md-2">
          <input required type="text" class="form-control" id="isbn" placeholder="ISBN">
          <div class="invalid-feedback">ISBN wajib diisi!</div>
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-success" type="submit">Tambah Buku</button>
        </div>
      </form>
    </div>
    <div id="alertBuku"></div>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Judul</th>
          <th>Pengarang</th>
          <th>Tahun</th>
          <th>Kategori</th>
          <th>ISBN</th>
          <th id="aksiHeader">Aksi</th>
        </tr>
      </thead>
      <tbody id="daftarBuku"></tbody>
    </table>
  </div>
  <script type="module">
    // --- Konfigurasi Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAvgK3-CN1qOQ_6hfhJOTEoNtyUkws-FWs",
      authDomain: "buku-perpustakaan-d5800.firebaseapp.com",
      projectId: "buku-perpustakaan-d5800",
      storageBucket: "buku-perpustakaan-d5800.firebasestorage.app",
      messagingSenderId: "272079716908",
      appId: "1:272079716908:web:f621036e0be69ef4ab4789",
      measurementId: "G-QR79PE11PS"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- SETTING EMAIL ADMIN ---
    const adminEmail = "admin@domain.com"; // Ganti dengan email admin kamu jika berbeda

    // --- DOM Elements ---
    const loginForm = document.getElementById('loginForm');
    const adminSection = document.getElementById('adminSection');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const aksiHeader = document.getElementById('aksiHeader');
    const alertBuku = document.getElementById('alertBuku');

    // --- Autentikasi & UI Logic ---
    auth.onAuthStateChanged(user => {
      if (user && user.email === adminEmail) {
        // ADMIN
        loginForm.style.display = 'none';
        adminSection.style.display = '';
        userInfo.style.display = '';
        userEmail.textContent = user.email;
        aksiHeader.style.display = '';
        tampilkanDaftarBuku(true);
      } else if (user) {
        // Bukan admin
        loginForm.style.display = 'none';
        adminSection.style.display = 'none';
        userInfo.style.display = '';
        userEmail.textContent = user.email;
        aksiHeader.style.display = 'none';
        tampilkanDaftarBuku(false);
      } else {
        // Belum login
        loginForm.style.display = '';
        adminSection.style.display = 'none';
        userInfo.style.display = 'none';
        aksiHeader.style.display = 'none';
        tampilkanDaftarBuku(false);
      }
    });

    loginForm.onsubmit = function(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => loginForm.reset())
        .catch(err => showAlert('danger', err.message));
    };

    logoutBtn.onclick = () => auth.signOut();

    // --- CRUD Buku ---
    async function tambahBuku(dataBuku) {
      try {
        await db.collection("buku").add(dataBuku);
        showAlert('success', "Buku berhasil ditambahkan!");
        tampilkanDaftarBuku(true);
      } catch (e) {
        showAlert('danger', e.message);
      }
    }

    async function hapusBuku(idBuku) {
      try {
        await db.collection("buku").doc(idBuku).delete();
        showAlert('success', "Buku berhasil dihapus!");
        tampilkanDaftarBuku(true);
      } catch (e) {
        showAlert('danger', e.message);
      }
    }

    async function tampilkanDaftarBuku(isAdmin) {
      const snapshot = await db.collection("buku").get();
      const tbody = document.getElementById('daftarBuku');
      tbody.innerHTML = '';
      snapshot.forEach(doc => {
        const buku = doc.data();
        let aksi = '';
        if (isAdmin) {
          aksi = `<button class="btn btn-danger btn-sm" data-id="${doc.id}">Hapus</button>`;
        }
        tbody.innerHTML += `
          <tr>
            <td>${buku.judul}</td>
            <td>${buku.pengarang}</td>
            <td>${buku.tahun}</td>
            <td>${buku.kategori}</td>
            <td>${buku.isbn}</td>
            <td>${aksi}</td>
          </tr>
        `;
      });
      if (isAdmin) {
        document.querySelectorAll('button.btn-danger').forEach(btn => {
          btn.onclick = function() {
            if (confirm('Yakin hapus buku ini?')) hapusBuku(this.dataset.id);
          };
        });
      }
    }

    // --- Validasi Form dan Tambah Buku (khusus admin) ---
    const formTambahBuku = document.getElementById('formTambahBuku');
    formTambahBuku && formTambahBuku.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopPropagation();
      if (!formTambahBuku.checkValidity()) {
        formTambahBuku.classList.add('was-validated');
        return;
      }
      const data = {
        judul: document.getElementById('judul').value,
        pengarang: document.getElementById('pengarang').value,
        tahun: parseInt(document.getElementById('tahun').value),
        kategori: document.getElementById('kategori').value,
        isbn: document.getElementById('isbn').value
      };
      tambahBuku(data);
      formTambahBuku.reset();
      formTambahBuku.classList.remove('was-validated');
    });

    // --- Alert helper ---
    function showAlert(type, msg) {
      alertBuku.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      setTimeout(() => {
        document.querySelectorAll('.alert').forEach(el => el.remove());
      }, 3500);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>